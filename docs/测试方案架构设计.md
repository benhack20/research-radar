# 科研成果监测平台测试方案架构设计（TDD驱动）

## 一、测试目标与原则

- **目标**：确保平台各功能模块的正确性、健壮性、安全性和可维护性，支持持续集成与快速迭代。
- **原则**：
  - 所有功能开发前，先编写测试用例（TDD）。
  - 测试用例与业务代码分离，结构清晰。
  - 自动化测试为主，手工测试为辅。
  - 覆盖核心业务流程、边界条件、异常分支和安全场景。

---

## 二、测试分层与类型

1. **单元测试（Unit Test）**

   - 目标：验证最小功能单元（函数、类、方法）的正确性。
   - 工具：pytest（后端）、Jest（前端）。
   - 要求：每个业务函数、API适配器、数据模型方法均需有单元测试。
2. **集成测试（Integration Test）**

   - 目标：验证模块间协作、数据库交互、外部API调用等集成场景。
   - 工具：pytest+httpx（后端）、Jest+msw（前端）。
   - 要求：每个REST API接口、数据库操作、第三方API适配器均需有集成测试。
3. **端到端测试（E2E Test）**

   - 目标：模拟真实用户操作，验证前后端全链路流程。
   - 工具：Cypress、Playwright。
   - 要求：覆盖首页加载、学者检索、数据刷新、AI摘要、数据可视化等主流程。
4. **性能与压力测试**

   - 目标：验证系统在高并发、大数据量下的稳定性和响应速度。
   - 工具：Locust、JMeter。
   - 要求：对首页加载、批量刷新、AI摘要等接口进行压力测试。
5. **安全测试**

   - 目标：发现常见安全漏洞（如XSS、SQL注入、权限绕过等）。
   - 工具：OWASP ZAP、pytest安全插件。
   - 要求：接口权限、Token校验、输入校验等均需有安全测试。

---

## 三、TDD开发流程

1. **需求分析**：明确每个功能点的业务需求和预期行为。
2. **测试用例设计**：在开发前，先为该功能编写详细的测试用例（包括正常、异常、边界、权限等场景）。
3. **编写测试代码**：实现测试用例，确保其能独立运行（可用mock、fixture等隔离外部依赖）。
4. **实现业务代码**：仅在测试用例未通过时，开始编写/修改业务代码。
5. **运行测试**：持续运行测试，直至所有用例通过。
6. **重构与优化**：在保证测试全部通过的前提下，重构业务代码。
7. **提交与集成**：所有代码合并前，必须通过CI自动化测试。

---

## 四、测试用例设计（示例）

### 1. 后端API（以“学者数据刷新”为例）

- **单元测试**

  - 测试刷新函数能正确调用AMiner API并解析返回数据。
  - 测试数据库更新逻辑，确保只更新有变化的数据。
  - 测试异常处理（如AMiner API超时、返回异常格式等）。
- **集成测试**

  - 测试 `POST /api/scholar/{id}/refresh`接口，模拟真实请求，断言数据库数据被正确更新。
  - 测试权限校验，未授权用户请求应被拒绝。
- **E2E测试**

  - 用户登录后，进入学者详情页，点击“刷新数据”，前端展示最新成果，后端数据同步。

### 2. 前端页面（以“首页学者列表”展示为例）

- **单元测试**

  - 测试学者卡片组件能正确渲染传入的props。
  - 测试分页、筛选、排序逻辑。
- **集成测试**

  - 测试首页加载时能正确请求后端API并渲染数据。
  - 测试无数据、加载中、异常等状态的UI表现。
- **E2E测试**

  - 用户访问首页，能看到数据库中所有学者及其成果摘要，支持分页、筛选、排序。

---

## 五、自动化与CI集成

- **自动化要求**

  - 所有测试用例均可一键运行，支持本地与CI环境。
  - 代码提交/合并前自动触发测试，未通过则禁止合并。
  - 测试报告自动生成，便于追踪和回归。
- **覆盖率要求**

  - 单元测试覆盖率≥80%，核心业务代码≥90%。
  - 集成/E2E测试覆盖所有主流程和关键分支。

---

## 六、测试目录与组织结构建议

```
research-radar/
  ├── aminer/
  ├── tests/
  │   ├── unit/         # 单元测试
  │   ├── integration/  # 集成测试
  │   └── e2e/          # 端到端测试
  ├── frontend/
  │   └── src/
  │       └── __tests__/
  └── ...
```

---

## 七、TDD落地注意事项

- 每开发一个新功能，先写测试再写实现，测试未通过前不写业务代码。
- 发现bug时，先补充能复现bug的测试用例，再修复代码。
- 测试用例需覆盖正常、异常、边界、权限等多种场景。
- 测试代码需有注释，便于团队理解和维护。
- 测试数据与生产数据隔离，避免污染。

---
